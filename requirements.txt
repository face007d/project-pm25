from flask import Flask, request, jsonify
from flask_cors import CORS
import numpy as np
import joblib
import os
from tensorflow.keras.models import load_model

app = Flask(__name__)
CORS(app) 

# ดึงค่า PORT จาก Environment Variable (จำเป็นสำหรับการขึ้นเว็บ)
port = int(os.environ.get("PORT", 5000))

model_path = 'lstm_pm25_model (2).h5'
scaler_path = 'scaler (2).pkl'

# โหลดโมเดlเพียงครั้งเดียวตอนเริ่ม Server
if os.path.exists(model_path) and os.path.exists(scaler_path):
    model = load_model(model_path)
    scaler = joblib.load(scaler_path)
    print("✅ Model and Scaler loaded successfully!")
else:
    model = None
    scaler = None
    print("❌ Error: Missing model or scaler files!")

@app.route('/')
def home():
    return "PM2.5 Nakhon Phanom API is Running!"

@app.route('/predict', methods=['POST'])
def predict():
    if model is None or scaler is None:
        return jsonify({'error': 'Model not loaded'}), 500
        
    try:
        data = request.get_json()
        # รับข้อมูล [v1, v2, v3]
        inputs = np.array(data['inputs']).reshape(-1, 1)
        
        # Pre-processing
        input_scaled = scaler.transform(inputs)
        X_input = np.reshape(input_scaled, (1, 3, 1))
        
        # Prediction
        prediction_scaled = model.predict(X_input, verbose=0)
        
        # Inverse Transform กลับเป็นค่าฝุ่นจริง
        # สร้าง dummy matrix เพื่อใช้กับ scaler.inverse_transform
        prediction = scaler.inverse_transform(prediction_scaled)
        
        return jsonify({
            'prediction': float(prediction[0][0]),
            'unit': 'µg/m3'
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 400

if __name__ == '__main__':
    # รันโดยใช้ host 0.0.0.0 เพื่อให้ภายนอกเข้าถึงได้
    app.run(host='0.0.0.0', port=port)